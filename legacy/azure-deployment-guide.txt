AZURE CONTAINER DEPLOYMENT GUIDE
=================================

This guide covers deploying Docker containers (Backend and Frontend) to Azure App Service with Azure Container Registry.

PREREQUISITES
-------------
- Azure CLI installed and logged in: `az login`
- Docker installed locally
- Azure subscription with resource group created
- Cosmos DB PostgreSQL already deployed
- Cosmos DB for MongoDB vCore (for vector search) - see VECTOR DATABASE SETUP section
- Azure Storage Account already configured
- Azure AD App Registration completed

IMPORTANT URLS TO NOTE
---------------------
- Backend URL: https://<your-backend-name>.azurewebsites.net
- Frontend URL: https://<your-frontend-name>.azurewebsites.net
- ACR Login Server: <your-registry>.azurecr.io

=================================
VECTOR DATABASE SETUP - COSMOS DB FOR MONGODB VCORE
=================================

This replaces Pinecone for vector search functionality.

1. Create Cosmos DB for MongoDB vCore cluster:
   - Go to Azure Portal → Create Resource → Azure Cosmos DB
   - Choose "Azure Cosmos DB for MongoDB vCore"
   - Select M30 tier (minimum for vector search support)
   - Note: This costs ~$165/month

2. Configure the cluster:
   - Cluster name: studio-vector
   - Username: myadmin
   - Set a strong password
   - Enable "Allow access from anywhere" initially (restrict later)

3. After deployment, create vector index:
   - Connect to MongoDB shell in Azure Portal
   - Run these commands:
   ```javascript
   use vectordb
   db.runCommand({
     createIndexes: "documents",
     indexes: [{
       name: "vector_index",
       key: { embedding: "cosmosSearch" },
       cosmosSearchOptions: {
         kind: "vector-ivf",
         numLists: 100,
         similarity: "COS",
         dimensions: 1536
       }
     }]
   })
   ```

4. Update backend code:
   - Replace PineconeClient with CosmosVectorClient
   - Update all imports from pinecone_client to cosmos_vector_client
   - Update requirements.txt: replace 'pinecone' with 'pymongo[srv]'

5. Environment variables needed:
   - COSMOS_MONGODB_CONNECTION_STRING: Get from Azure Portal
   - COSMOS_DATABASE_NAME: "vectordb"
   - COSMOS_COLLECTION_NAME: "documents"

=================================
PART 1: CREATE AZURE CONTAINER REGISTRY (ACR)
=================================

1. Create ACR via Azure CLI:
   ```
   az acr create \
     --resource-group stealth \
     --name studio \
     --sku Basic \
     --location eastus
   ```

2. Enable admin user:
   ```
   az acr update --name studio --admin-enabled true
   ```

3. Get ACR credentials (save these!):
   ```
   az acr credential show --name studio
   ```
   Note: Save the username and password

4. Login to ACR:
   ```
   az acr login --name studio
   ```

=================================
PART 2: BUILD AND PUSH BACKEND IMAGE
=================================

CRITICAL: Azure App Service requires linux/amd64 architecture!

1. Build backend image for AMD64:
   ```
   az acr build --registry studio --image backend:latest --platform linux/amd64 ./backend
   ```

2. Verify image was pushed:
   ```
   az acr repository show-tags --name studio --repository backend
   ```

=================================
PART 3: CREATE BACKEND APP SERVICE
=================================

1. Create App Service Plan:
   ```
   az appservice plan create \
     --name backend-plan \
     --resource-group stealth \
     --location eastus \
     --is-linux \
     --sku B1
   ```

2. Create Web App for Containers:
   ```
   az webapp create \
     --resource-group stealth \
     --plan backend-plan \
     --name studio-backend \
     --deployment-container-image-name studio.azurecr.io/backend:latest
   ```

3. Configure ACR credentials:
   ```
   az webapp config container set \
     --name studio-backend \
     --resource-group stealth \
     --docker-custom-image-name studio.azurecr.io/backend:latest \
     --docker-registry-server-url https://studio.azurecr.io \
     --docker-registry-server-user studio \
     --docker-registry-server-password <ACR_PASSWORD>
   ```

4. Set environment variables (all at once):
   ```
   az webapp config appsettings set \
     --name studio-backend \
     --resource-group stealth \
     --settings \
       PYTHONPATH="/app" \
       PORT="8000" \
       WEBSITES_PORT="8000" \
       DATABASE_URL="postgres://citus:<password>@<cosmos-host>.postgres.cosmos.azure.com:5432/citus?sslmode=require" \
       COSMOS_MONGODB_CONNECTION_STRING="mongodb+srv://<username>:<password>@<cluster>.mongocluster.cosmos.azure.com/?tls=true&authMechanism=SCRAM-SHA-256&retrywrites=false&maxIdleTimeMS=120000" \
       COSMOS_DATABASE_NAME="vectordb" \
       COSMOS_COLLECTION_NAME="documents" \
       AZURE_OPENAI_ENDPOINT="https://<your-resource>.cognitiveservices.azure.com/" \
       AZURE_OPENAI_API_KEY="<your-key>" \
       AZURE_OPENAI_API_VERSION="2025-01-01-preview" \
       MODEL_NAME="gpt-4o" \
       SMALL_MODEL_NAME="gpt-4o-mini" \
       EMBEDDING_MODEL_NAME="text-embedding-3-small" \
       AZURE_AD_CLIENT_ID="<your-client-id>" \
       AZURE_AD_TENANT_ID="<your-tenant-id>" \
       AZURE_AD_ISSUER="https://login.microsoftonline.com/<tenant-id>/v2.0" \
       AZURE_STORAGE_ACCOUNT_NAME="<storage-account>" \
       AZURE_STORAGE_ACCOUNT_KEY="<storage-key>" \
       AZURE_STORAGE_CONNECTION_STRING="<connection-string>" \
       AZURE_STORAGE_CONTAINER_NAME="user-files" \
       AZURE_STORAGE_BLOB_ENDPOINT="https://<storage-account>.blob.core.windows.net/" \
       PGHOST="<cosmos-host>.postgres.cosmos.azure.com" \
       PGPORT="5432" \
       PGUSER="citus" \
       PGPASSWORD="<password>" \
       PGDATABASE="citus" \
       PGSSLMODE="require" \
       CORS_ORIGINS="https://<your-frontend-url>.azurewebsites.net"
   ```

5. Configure health check:
   ```
   az webapp config set \
     --name studio-backend \
     --resource-group stealth \
     --startup-file "" \
     --health-check-path "/health"
   ```

6. Enable logging:
   ```
   az webapp log config \
     --name studio-backend \
     --resource-group stealth \
     --application-logging filesystem \
     --level verbose
   ```

7. Restart the app:
   ```
   az webapp restart --name studio-backend --resource-group stealth
   ```

8. Test backend health:
   ```
   curl https://<your-backend-url>/health
   ```

=================================
PART 4: BUILD AND PUSH FRONTEND IMAGE
=================================

CRITICAL: Next.js NEXT_PUBLIC_* variables must be passed as build arguments!

1. Build frontend with all required build args:
   ```
   az acr build --registry studio --image frontend:latest --platform linux/amd64 \
     --build-arg NEXT_PUBLIC_BACKEND_SERVER_URL="https://<backend-url>.azurewebsites.net" \
     --build-arg NEXT_PUBLIC_SITE_URL="https://<frontend-url>.azurewebsites.net" \
     --build-arg NEXT_PUBLIC_AZURE_AD_CLIENT_ID="<client-id>" \
     --build-arg NEXT_PUBLIC_AZURE_AD_TENANT_ID="<tenant-id>" \
     --build-arg NEXT_PUBLIC_AZURE_AD_REDIRECT_URI="https://<frontend-url>.azurewebsites.net/auth/callback" \
     --build-arg NEXT_PUBLIC_AZURE_AD_AUTHORITY="https://login.microsoftonline.com/<tenant-id>" \
     ./frontend
   ```

2. Verify image:
   ```
   az acr repository show-tags --name studio --repository frontend
   ```

=================================
PART 5: CREATE FRONTEND APP SERVICE
=================================

1. Create App Service Plan (if not using existing):
   ```
   az appservice plan create \
     --name frontend-plan \
     --resource-group stealth \
     --location eastus \
     --is-linux \
     --sku B1
   ```

2. Create Web App:
   ```
   az webapp create \
     --resource-group stealth \
     --plan frontend-plan \
     --name studio-frontend \
     --deployment-container-image-name studio.azurecr.io/frontend:latest
   ```

3. Configure ACR credentials:
   ```
   az webapp config container set \
     --name studio-frontend \
     --resource-group stealth \
     --docker-custom-image-name studio.azurecr.io/frontend:latest \
     --docker-registry-server-url https://studio.azurecr.io \
     --docker-registry-server-user studio \
     --docker-registry-server-password <ACR_PASSWORD>
   ```

4. Set environment variables:
   ```
   az webapp config appsettings set \
     --name studio-frontend \
     --resource-group stealth \
     --settings \
       PORT="3000" \
       WEBSITES_PORT="3000" \
       NODE_ENV="production" \
       BACKEND_SERVER_URL="https://<backend-url>.azurewebsites.net" \
       NEXT_PUBLIC_BACKEND_SERVER_URL="https://<backend-url>.azurewebsites.net" \
       NEXT_PUBLIC_SITE_URL="https://<frontend-url>.azurewebsites.net" \
       DATABASE_URL="<same-as-backend>" \
       AZURE_AD_CLIENT_ID="<client-id>" \
       AZURE_AD_CLIENT_SECRET="<client-secret>" \
       AZURE_AD_TENANT_ID="<tenant-id>" \
       AZURE_AD_REDIRECT_URI="https://<frontend-url>.azurewebsites.net/auth/callback" \
       AZURE_AD_AUTHORITY="https://login.microsoftonline.com/<tenant-id>" \
       NEXT_PUBLIC_AZURE_AD_CLIENT_ID="<client-id>" \
       NEXT_PUBLIC_AZURE_AD_TENANT_ID="<tenant-id>" \
       NEXT_PUBLIC_AZURE_AD_REDIRECT_URI="https://<frontend-url>.azurewebsites.net/auth/callback" \
       NEXT_PUBLIC_AZURE_AD_AUTHORITY="https://login.microsoftonline.com/<tenant-id>" \
       NEXTAUTH_URL="https://<frontend-url>.azurewebsites.net" \
       NEXTAUTH_SECRET="<generate-with-openssl-rand-base64-32>" \
       AZURE_STORAGE_ACCOUNT_NAME="<storage-account>" \
       AZURE_STORAGE_ACCOUNT_KEY="<storage-key>" \
       AZURE_STORAGE_CONNECTION_STRING="<connection-string>" \
       AZURE_STORAGE_CONTAINER_NAME="user-files"
   ```

5. Generate NEXTAUTH_SECRET:
   ```
   openssl rand -base64 32
   ```

6. Enable logging:
   ```
   az webapp log config \
     --name studio-frontend \
     --resource-group stealth \
     --application-logging filesystem \
     --level verbose
   ```

7. Restart frontend:
   ```
   az webapp restart --name studio-frontend --resource-group stealth
   ```

=================================
PART 6: CONFIGURE AZURE AD
=================================

1. Via Azure Portal:
   - Go to Azure Active Directory → App registrations
   - Find your app (use client ID to search)
   - Go to Authentication
   - Under "Single-page application", add:
     https://<frontend-url>.azurewebsites.net/auth/callback
   - Ensure "ID tokens" and "Access tokens" are checked
   - Save

2. Via Azure CLI:
   ```
   az ad app update --id <client-id> \
     --spa-redirect-uris "https://<frontend-url>.azurewebsites.net/auth/callback"
   ```

=================================
TROUBLESHOOTING
=================================

1. GENERAL DEBUGGING COMMANDS:
   ```
   # Stream logs
   az webapp log tail --name <app-name> --resource-group stealth
   
   # Download logs
   az webapp log download --name <app-name> --resource-group stealth --log-file logs.zip
   
   # Check app settings
   az webapp config appsettings list --name <app-name> --resource-group stealth
   
   # Force restart
   az webapp restart --name <app-name> --resource-group stealth
   
   # Stop the app
   az webapp stop --name <app-name> --resource-group stealth
   
   # Start the app
   az webapp start --name <app-name> --resource-group stealth
   
   # Check container status via Kudu
   https://<app-name>.scm.azurewebsites.net
   
   # Update single environment variable
   az webapp config appsettings set --name <app-name> --resource-group stealth --settings KEY="value"
   
   # Delete environment variable
   az webapp config appsettings delete --name <app-name> --resource-group stealth --setting-names KEY
   
   # List all ACR repositories
   az acr repository list --name studio --output table
   
   # Show specific image tags
   az acr repository show-tags --name studio --repository <image-name>
   
   # Delete an image from ACR
   az acr repository delete --name studio --image <image-name>:<tag>
   
   # Update container image
   az webapp config container set \
     --name <app-name> \
     --resource-group stealth \
     --docker-custom-image-name studio.azurecr.io/<image>:<tag>
   ```

2. COMMON ISSUES:
   - Container fails to start: Check logs for specific errors
   - Authentication redirects to localhost: Clear browser cache and cookies
   - API calls failing: Verify CORS_ORIGINS on backend includes frontend URL
   - Environment variables not working: Remember NEXT_PUBLIC_* must be in build args

=================================
VERIFICATION CHECKLIST
=================================

[ ] Backend health check returns 200: https://<backend>/health
[ ] Backend API docs accessible: https://<backend>/docs
[ ] Frontend loads: https://<frontend>/
[ ] Authentication flow works
[ ] User can access dashboard after login
[ ] API calls from frontend to backend work
[ ] File uploads work (Azure Storage)
[ ] Database queries work (Cosmos DB)
[ ] Processing fields works (test in template page)

=================================
USEFUL CLI COMMANDS REFERENCE
=================================

ACR COMMANDS:
```
# Login to ACR
az acr login --name studio

# Build and push in one command
az acr build --registry studio --image <name>:latest --platform linux/amd64 ./<directory>

# List all images
az acr repository list --name studio

# Get ACR login server
az acr show --name studio --query loginServer

# Get ACR credentials
az acr credential show --name studio
```

APP SERVICE COMMANDS:
```
# List all web apps
az webapp list --resource-group stealth --output table

# Show web app details
az webapp show --name <app-name> --resource-group stealth

# Open app in browser
az webapp browse --name <app-name> --resource-group stealth

# Scale app service plan
az appservice plan update --name <plan-name> --resource-group stealth --sku B2

# Enable continuous deployment from ACR
az webapp deployment container config --name <app-name> --resource-group stealth --enable-cd true
```

AZURE AD COMMANDS:
```
# Show app registration
az ad app show --id <client-id>

# List redirect URIs
az ad app show --id <client-id> --query "spa.redirectUris"

# Update redirect URIs
az ad app update --id <client-id> --spa-redirect-uris "https://url1" "https://url2"
```

=================================
IMPORTANT NOTES
=================================

1. Always build for linux/amd64 platform
2. NEXT_PUBLIC_* variables must be passed as build arguments
3. Enable logging before deployment for easier troubleshooting
4. Container initialization takes 1-2 minutes
5. Health checks may fail initially during warmup
6. Keep ACR credentials secure
7. Regularly update container images for security patches
8. Clear browser cache after authentication changes