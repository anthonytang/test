{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "13018777523674177306"
    }
  },
  "parameters": {
    "customerPrefix": {
      "type": "string",
      "minLength": 3,
      "maxLength": 10,
      "metadata": {
        "description": "Customer prefix for resource naming (3-10 alphanumeric chars)"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "dev",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "eastus",
      "metadata": {
        "description": "Azure region for all resources"
      }
    },
    "appServicePlanSku": {
      "type": "string",
      "defaultValue": "B1",
      "allowedValues": [
        "B1",
        "B2",
        "S1",
        "S2",
        "P1v3",
        "P2v3"
      ],
      "metadata": {
        "description": "App Service Plan SKU"
      }
    },
    "tenantId": {
      "type": "securestring",
      "metadata": {
        "description": "Azure AD Tenant ID"
      }
    },
    "clientId": {
      "type": "securestring",
      "metadata": {
        "description": "Azure AD Client ID for authentication"
      }
    },
    "clientSecret": {
      "type": "securestring",
      "metadata": {
        "description": "Azure AD Client Secret"
      }
    },
    "postgresPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Cosmos DB PostgreSQL admin password"
      }
    },
    "mongoPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Cosmos DB MongoDB admin password"
      }
    },
    "deployGpt4": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Deploy GPT-4 model (costs more)"
      }
    },
    "deployGpt35": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy GPT-3.5 Turbo model"
      }
    },
    "deployEmbeddings": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Deploy text embedding model"
      }
    }
  },
  "variables": {
    "resourceGroupName": "[format('{0}-studio-{1}-rg', parameters('customerPrefix'), parameters('environment'))]",
    "resourcePrefix": "[format('{0}-studio-{1}', parameters('customerPrefix'), parameters('environment'))]",
    "commonTags": {
      "Environment": "[parameters('environment')]",
      "Customer": "[parameters('customerPrefix')]",
      "Project": "studio",
      "ManagedBy": "bicep",
      "DeployedBy": "infrastructure-as-code"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2023-07-01",
      "name": "[variables('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[variables('commonTags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "keyvault-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "11959230071084122171"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource prefix for naming"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Tenant ID"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            },
            "enablePrivateEndpoints": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable private endpoints"
              }
            }
          },
          "variables": {
            "keyVaultName": "[format('{0}-kv', parameters('resourcePrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[variables('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "tenantId": "[parameters('tenantId')]",
                "enabledForDeployment": true,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "enableRbacAuthorization": true,
                "enableSoftDelete": true,
                "softDeleteRetentionInDays": 7,
                "enablePurgeProtection": false,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "[if(parameters('enablePrivateEndpoints'), 'Deny', 'Allow')]"
                },
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoints'), 'Disabled', 'Enabled')]"
              }
            }
          ],
          "outputs": {
            "keyVaultName": {
              "type": "string",
              "value": "[variables('keyVaultName')]"
            },
            "keyVaultId": {
              "type": "string",
              "value": "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
            },
            "keyVaultUri": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName')), '2023-07-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "storage-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "3130302506132226189"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource prefix for naming"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment (dev, staging, prod)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            },
            "enablePrivateEndpoints": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable private endpoints"
              }
            }
          },
          "variables": {
            "storageAccountName": "[replace(format('{0}storage', parameters('resourcePrefix')), '-', '')]",
            "tier": "[if(equals(parameters('environment'), 'prod'), 'Premium', 'Standard')]",
            "replication": "[if(equals(parameters('environment'), 'prod'), 'GRS', 'LRS')]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-01-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[format('{0}_{1}', variables('tier'), variables('replication'))]"
              },
              "kind": "StorageV2",
              "properties": {
                "accessTier": "Hot",
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "[if(parameters('enablePrivateEndpoints'), 'Deny', 'Allow')]"
                },
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoints'), 'Disabled', 'Enabled')]"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}', variables('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": [
                    {
                      "allowedOrigins": [
                        "*"
                      ],
                      "allowedMethods": [
                        "GET",
                        "POST",
                        "PUT",
                        "DELETE",
                        "HEAD",
                        "OPTIONS"
                      ],
                      "allowedHeaders": [
                        "*"
                      ],
                      "exposedHeaders": [
                        "*"
                      ],
                      "maxAgeInSeconds": 3600
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'user-files')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'temp-files')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2023-01-01",
              "name": "[format('{0}/{1}/{2}', variables('storageAccountName'), 'default', 'backups')]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', variables('storageAccountName'), 'default')]"
              ]
            }
          ],
          "outputs": {
            "storageAccountName": {
              "type": "string",
              "value": "[variables('storageAccountName')]"
            },
            "storageAccountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
            },
            "connectionString": {
              "type": "string",
              "value": "[format('DefaultEndpointsProtocol=https;AccountName={0};AccountKey={1};EndpointSuffix={2}', variables('storageAccountName'), listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').keys[0].value, if(equals(parameters('environment'), 'prod'), 'core.windows.net', 'core.windows.net'))]"
            },
            "primaryEndpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2023-01-01').primaryEndpoints.blob]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "openai-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "deployGpt4": {
            "value": "[parameters('deployGpt4')]"
          },
          "deployGpt35": {
            "value": "[parameters('deployGpt35')]"
          },
          "deployEmbeddings": {
            "value": "[parameters('deployEmbeddings')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "6206001262102247208"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource prefix for naming"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "deployGpt4": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Deploy GPT-4 model"
              }
            },
            "deployGpt35": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Deploy GPT-3.5 Turbo model"
              }
            },
            "deployEmbeddings": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Deploy embeddings model"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            },
            "enablePrivateEndpoints": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable private endpoints"
              }
            }
          },
          "variables": {
            "openaiServiceName": "[format('{0}-openai', parameters('resourcePrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2023-05-01",
              "name": "[variables('openaiServiceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "S0"
              },
              "kind": "OpenAI",
              "properties": {
                "customSubDomainName": "[variables('openaiServiceName')]",
                "networkAcls": {
                  "defaultAction": "[if(parameters('enablePrivateEndpoints'), 'Deny', 'Allow')]",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoints'), 'Disabled', 'Enabled')]"
              }
            },
            {
              "condition": "[parameters('deployGpt35')]",
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('openaiServiceName'), 'gpt-35-turbo')]",
              "sku": {
                "name": "Standard",
                "capacity": 20
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-35-turbo",
                  "version": "0613"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openaiServiceName'))]"
              ]
            },
            {
              "condition": "[parameters('deployGpt4')]",
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('openaiServiceName'), 'gpt-4')]",
              "sku": {
                "name": "Standard",
                "capacity": 10
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "gpt-4",
                  "version": "0613"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', variables('openaiServiceName'), 'gpt-35-turbo')]",
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openaiServiceName'))]"
              ]
            },
            {
              "condition": "[parameters('deployEmbeddings')]",
              "type": "Microsoft.CognitiveServices/accounts/deployments",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', variables('openaiServiceName'), 'text-embedding-ada-002')]",
              "sku": {
                "name": "Standard",
                "capacity": 30
              },
              "properties": {
                "model": {
                  "format": "OpenAI",
                  "name": "text-embedding-ada-002",
                  "version": "2"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', variables('openaiServiceName'), 'gpt-35-turbo')]",
                "[resourceId('Microsoft.CognitiveServices/accounts/deployments', variables('openaiServiceName'), 'gpt-4')]",
                "[resourceId('Microsoft.CognitiveServices/accounts', variables('openaiServiceName'))]"
              ]
            }
          ],
          "outputs": {
            "serviceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', variables('openaiServiceName'))]"
            },
            "serviceName": {
              "type": "string",
              "value": "[variables('openaiServiceName')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', variables('openaiServiceName')), '2023-05-01').endpoint]"
            },
            "apiKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.CognitiveServices/accounts', variables('openaiServiceName')), '2023-05-01').key1]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmos-postgres-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "administratorLoginPassword": {
            "value": "[parameters('postgresPassword')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "16085320110670664992"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource prefix for naming"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment (dev, staging, prod)"
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Administrator login password"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            },
            "enablePrivateEndpoints": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable private endpoints"
              }
            }
          },
          "variables": {
            "clusterName": "[format('{0}-postgres', parameters('resourcePrefix'))]",
            "coordinatorVcoreCount": "[if(equals(parameters('environment'), 'prod'), 8, if(equals(parameters('environment'), 'staging'), 4, 2))]",
            "coordinatorStorageQuotaInMb": "[if(equals(parameters('environment'), 'prod'), 524288, if(equals(parameters('environment'), 'staging'), 262144, 131072))]",
            "nodeCount": "[if(equals(parameters('environment'), 'prod'), 2, if(equals(parameters('environment'), 'staging'), 1, 0))]",
            "enableHA": "[equals(parameters('environment'), 'prod')]"
          },
          "resources": [
            {
              "type": "Microsoft.DBforPostgreSQL/serverGroupsv2",
              "apiVersion": "2022-11-08",
              "name": "[variables('clusterName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "postgresqlVersion": "15",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "enableHa": "[variables('enableHA')]",
                "coordinatorVCores": "[variables('coordinatorVcoreCount')]",
                "coordinatorStorageQuotaInMb": "[variables('coordinatorStorageQuotaInMb')]",
                "coordinatorEnablePublicIpAccess": "[not(parameters('enablePrivateEndpoints'))]",
                "nodeVCores": "[if(greater(variables('nodeCount'), 0), 4, 0)]",
                "nodeCount": "[variables('nodeCount')]",
                "nodeStorageQuotaInMb": "[if(greater(variables('nodeCount'), 0), 262144, 0)]",
                "nodeEnablePublicIpAccess": "[not(parameters('enablePrivateEndpoints'))]"
              }
            },
            {
              "type": "Microsoft.DBforPostgreSQL/serverGroupsv2/databases",
              "apiVersion": "2022-11-08",
              "name": "[format('{0}/{1}', variables('clusterName'), 'studio')]",
              "dependsOn": [
                "[resourceId('Microsoft.DBforPostgreSQL/serverGroupsv2', variables('clusterName'))]"
              ]
            }
          ],
          "outputs": {
            "clusterId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DBforPostgreSQL/serverGroupsv2', variables('clusterName'))]"
            },
            "clusterName": {
              "type": "string",
              "value": "[variables('clusterName')]"
            },
            "connectionString": {
              "type": "string",
              "value": "[format('host={0};port=5432;database=studio;username=citus;password={1};sslmode=require', reference(resourceId('Microsoft.DBforPostgreSQL/serverGroupsv2', variables('clusterName')), '2022-11-08').serverNames[0].fullyQualifiedDomainName, parameters('administratorLoginPassword'))]"
            },
            "serverName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/serverGroupsv2', variables('clusterName')), '2022-11-08').serverNames[0].fullyQualifiedDomainName]"
            },
            "databaseName": {
              "type": "string",
              "value": "studio"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmos-mongo-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "environment": {
            "value": "[parameters('environment')]"
          },
          "administratorLoginPassword": {
            "value": "[parameters('mongoPassword')]"
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "5739579940754993636"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource prefix for naming"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "environment": {
              "type": "string",
              "metadata": {
                "description": "Environment (dev, staging, prod)"
              }
            },
            "administratorLoginPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Administrator login password"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            }
          },
          "variables": {
            "clusterName": "[format('{0}-mongo', parameters('resourcePrefix'))]",
            "skuName": "[if(equals(parameters('environment'), 'prod'), 'M50', if(equals(parameters('environment'), 'staging'), 'M40', 'M30'))]",
            "diskSizeGB": "[if(equals(parameters('environment'), 'prod'), 128, if(equals(parameters('environment'), 'staging'), 64, 32))]",
            "nodeCount": "[if(equals(parameters('environment'), 'prod'), 3, if(equals(parameters('environment'), 'staging'), 2, 1))]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/mongoClusters",
              "apiVersion": "2023-03-01-preview",
              "name": "[variables('clusterName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "administratorLogin": "mongodbadmin",
                "administratorLoginPassword": "[parameters('administratorLoginPassword')]",
                "serverVersion": "5.0",
                "nodeGroupSpecs": [
                  {
                    "kind": "Shard",
                    "sku": "[variables('skuName')]",
                    "diskSizeGB": "[variables('diskSizeGB')]",
                    "enableHa": "[equals(parameters('environment'), 'prod')]",
                    "nodeCount": "[variables('nodeCount')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "accountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/mongoClusters', variables('clusterName'))]"
            },
            "clusterName": {
              "type": "string",
              "value": "[variables('clusterName')]"
            },
            "connectionString": {
              "type": "string",
              "value": "[format('mongodb+srv://mongodbadmin:{0}@{1}/?tls=true&authMechanism=SCRAM-SHA-256&retrywrites=false&maxIdleTimeMS=120000', parameters('administratorLoginPassword'), reference(resourceId('Microsoft.DocumentDB/mongoClusters', variables('clusterName')), '2023-03-01-preview').connectionString)]"
            },
            "serverName": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/mongoClusters', variables('clusterName')), '2023-03-01-preview').connectionString]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "appservice-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "resourcePrefix": {
            "value": "[variables('resourcePrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appServicePlanSku": {
            "value": "[parameters('appServicePlanSku')]"
          },
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment'), '2022-09-01').outputs.keyVaultName.value]"
          },
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2022-09-01').outputs.storageAccountName.value]"
          },
          "openaiEndpoint": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'openai-deployment'), '2022-09-01').outputs.endpoint.value]"
          },
          "tenantId": {
            "value": "[parameters('tenantId')]"
          },
          "clientId": {
            "value": "[parameters('clientId')]"
          },
          "appInsightsInstrumentationKey": {
            "value": ""
          },
          "appInsightsConnectionString": {
            "value": ""
          },
          "tags": {
            "value": "[variables('commonTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "4722267070392619752"
            }
          },
          "parameters": {
            "resourcePrefix": {
              "type": "string",
              "metadata": {
                "description": "Resource prefix for naming"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region"
              }
            },
            "appServicePlanSku": {
              "type": "string",
              "metadata": {
                "description": "App Service Plan SKU"
              }
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage account name"
              }
            },
            "openaiEndpoint": {
              "type": "string",
              "metadata": {
                "description": "OpenAI endpoint"
              }
            },
            "tenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Tenant ID"
              }
            },
            "clientId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Client ID"
              }
            },
            "appInsightsInstrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "Application Insights instrumentation key"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Resource tags"
              }
            },
            "enablePrivateEndpoints": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable private endpoints"
              }
            },
            "subnetId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Subnet ID for App Service integration"
              }
            }
          },
          "variables": {
            "appServicePlanName": "[format('{0}-plan', parameters('resourcePrefix'))]",
            "frontendAppName": "[format('{0}-frontend', parameters('resourcePrefix'))]",
            "backendAppName": "[format('{0}-backend', parameters('resourcePrefix'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Web/serverfarms",
              "apiVersion": "2023-01-01",
              "name": "[variables('appServicePlanName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('appServicePlanSku')]"
              },
              "properties": {
                "reserved": false
              }
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[variables('frontendAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "httpsOnly": true,
                "clientAffinityEnabled": false,
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoints'), 'Disabled', 'Enabled')]",
                "virtualNetworkSubnetId": "[if(and(parameters('enablePrivateEndpoints'), not(empty(parameters('subnetId')))), parameters('subnetId'), null())]",
                "siteConfig": {
                  "nodeVersion": "20-lts",
                  "alwaysOn": "[not(equals(parameters('appServicePlanSku'), 'B1'))]",
                  "minTlsVersion": "1.2",
                  "ftpsState": "Disabled",
                  "httpLoggingEnabled": true,
                  "detailedErrorLoggingEnabled": true,
                  "requestTracingEnabled": true,
                  "appSettings": [
                    {
                      "name": "NEXT_PUBLIC_BACKEND_SERVER_URL",
                      "value": "[format('https://{0}.azurewebsites.net', variables('backendAppName'))]"
                    },
                    {
                      "name": "NEXT_PUBLIC_AZURE_AD_CLIENT_ID",
                      "value": "[parameters('clientId')]"
                    },
                    {
                      "name": "NEXT_PUBLIC_AZURE_AD_TENANT_ID",
                      "value": "[parameters('tenantId')]"
                    },
                    {
                      "name": "NEXT_PUBLIC_AZURE_AD_REDIRECT_URI",
                      "value": "[format('https://{0}.azurewebsites.net/auth/callback', variables('frontendAppName'))]"
                    },
                    {
                      "name": "NEXT_PUBLIC_AZURE_AD_AUTHORITY",
                      "value": "[format('https://login.microsoftonline.com/{0}', parameters('tenantId'))]"
                    },
                    {
                      "name": "AZURE_STORAGE_ACCOUNT_NAME",
                      "value": "[parameters('storageAccountName')]"
                    },
                    {
                      "name": "AZURE_STORAGE_CONTAINER_NAME",
                      "value": "user-files"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('appInsightsInstrumentationKey')]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "NODE_ENV",
                      "value": "production"
                    },
                    {
                      "name": "NEXT_TELEMETRY_DISABLED",
                      "value": "1"
                    }
                  ]
                }
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
              ]
            },
            {
              "type": "Microsoft.Web/sites",
              "apiVersion": "2023-01-01",
              "name": "[variables('backendAppName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "httpsOnly": true,
                "clientAffinityEnabled": false,
                "publicNetworkAccess": "[if(parameters('enablePrivateEndpoints'), 'Disabled', 'Enabled')]",
                "virtualNetworkSubnetId": "[if(and(parameters('enablePrivateEndpoints'), not(empty(parameters('subnetId')))), parameters('subnetId'), null())]",
                "siteConfig": {
                  "pythonVersion": "3.11",
                  "alwaysOn": "[not(equals(parameters('appServicePlanSku'), 'B1'))]",
                  "minTlsVersion": "1.2",
                  "ftpsState": "Disabled",
                  "httpLoggingEnabled": true,
                  "detailedErrorLoggingEnabled": true,
                  "requestTracingEnabled": true,
                  "cors": {
                    "allowedOrigins": [
                      "*"
                    ],
                    "supportCredentials": true
                  },
                  "appSettings": [
                    {
                      "name": "AZURE_OPENAI_API_KEY",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=azure-openai-api-key)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "AZURE_OPENAI_ENDPOINT",
                      "value": "[parameters('openaiEndpoint')]"
                    },
                    {
                      "name": "AZURE_OPENAI_API_VERSION",
                      "value": "2024-02-01"
                    },
                    {
                      "name": "COSMOS_POSTGRESQL_CONNECTION",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=cosmos-postgresql-connection)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "COSMOS_MONGODB_CONNECTION",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=cosmos-mongodb-connection)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "STORAGE_ACCOUNT_CONNECTION",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=storage-connection-string)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "AZURE_AD_TENANT_ID",
                      "value": "[parameters('tenantId')]"
                    },
                    {
                      "name": "AZURE_AD_CLIENT_ID",
                      "value": "[parameters('clientId')]"
                    },
                    {
                      "name": "AZURE_AD_CLIENT_SECRET",
                      "value": "[format('@Microsoft.KeyVault(VaultName={0};SecretName=azure-ad-client-secret)', parameters('keyVaultName'))]"
                    },
                    {
                      "name": "AZURE_STORAGE_ACCOUNT_NAME",
                      "value": "[parameters('storageAccountName')]"
                    },
                    {
                      "name": "AZURE_STORAGE_CONTAINER_NAME",
                      "value": "user-files"
                    },
                    {
                      "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                      "value": "[parameters('appInsightsInstrumentationKey')]"
                    },
                    {
                      "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                      "value": "[parameters('appInsightsConnectionString')]"
                    },
                    {
                      "name": "PYTHONPATH",
                      "value": "/app"
                    },
                    {
                      "name": "PYTHONUNBUFFERED",
                      "value": "1"
                    }
                  ],
                  "appCommandLine": "uvicorn server:app --host 0.0.0.0 --port 8000"
                }
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/add', parameters('keyVaultName'))]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "[parameters('tenantId')]",
                    "objectId": "[reference(resourceId('Microsoft.Web/sites', variables('frontendAppName')), '2023-01-01', 'full').identity.principalId]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('frontendAppName'))]"
              ]
            },
            {
              "type": "Microsoft.KeyVault/vaults/accessPolicies",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/add', parameters('keyVaultName'))]",
              "properties": {
                "accessPolicies": [
                  {
                    "tenantId": "[parameters('tenantId')]",
                    "objectId": "[reference(resourceId('Microsoft.Web/sites', variables('backendAppName')), '2023-01-01', 'full').identity.principalId]",
                    "permissions": {
                      "secrets": [
                        "get",
                        "list"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('backendAppName'))]",
                "[resourceId('Microsoft.KeyVault/vaults/accessPolicies', split(format('{0}/add', parameters('keyVaultName')), '/')[0], split(format('{0}/add', parameters('keyVaultName')), '/')[1])]"
              ]
            }
          ],
          "outputs": {
            "appServicePlanId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
            },
            "frontendAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', variables('frontendAppName'))]"
            },
            "frontendUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', variables('frontendAppName')), '2023-01-01').defaultHostName)]"
            },
            "backendAppId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Web/sites', variables('backendAppName'))]"
            },
            "backendUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.Web/sites', variables('backendAppName')), '2023-01-01').defaultHostName)]"
            },
            "frontendPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('frontendAppName')), '2023-01-01', 'full').identity.principalId]"
            },
            "backendPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Web/sites', variables('backendAppName')), '2023-01-01', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'openai-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "secrets-deployment",
      "resourceGroup": "[variables('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "keyVaultName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment'), '2022-09-01').outputs.keyVaultName.value]"
          },
          "cosmosPostgresConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'cosmos-postgres-deployment'), '2022-09-01').outputs.connectionString.value]"
          },
          "cosmosMongoConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'cosmos-mongo-deployment'), '2022-09-01').outputs.connectionString.value]"
          },
          "storageConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2022-09-01').outputs.connectionString.value]"
          },
          "openaiApiKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'openai-deployment'), '2022-09-01').outputs.apiKey.value]"
          },
          "openaiEndpoint": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'openai-deployment'), '2022-09-01').outputs.endpoint.value]"
          },
          "clientSecret": {
            "value": "[parameters('clientSecret')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.37.4.10188",
              "templateHash": "2227642728122316646"
            }
          },
          "parameters": {
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "Key Vault name"
              }
            },
            "cosmosPostgresConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Cosmos PostgreSQL connection string"
              }
            },
            "cosmosMongoConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Cosmos MongoDB connection string"
              }
            },
            "storageConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Storage connection string"
              }
            },
            "openaiApiKey": {
              "type": "securestring",
              "metadata": {
                "description": "OpenAI API key"
              }
            },
            "openaiEndpoint": {
              "type": "string",
              "metadata": {
                "description": "OpenAI endpoint"
              }
            },
            "clientSecret": {
              "type": "securestring",
              "metadata": {
                "description": "Azure AD client secret"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'cosmos-postgresql-connection')]",
              "properties": {
                "value": "[parameters('cosmosPostgresConnectionString')]",
                "contentType": "connection-string"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'cosmos-mongodb-connection')]",
              "properties": {
                "value": "[parameters('cosmosMongoConnectionString')]",
                "contentType": "connection-string"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'storage-connection-string')]",
              "properties": {
                "value": "[parameters('storageConnectionString')]",
                "contentType": "connection-string"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-openai-api-key')]",
              "properties": {
                "value": "[parameters('openaiApiKey')]",
                "contentType": "api-key"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-openai-endpoint')]",
              "properties": {
                "value": "[parameters('openaiEndpoint')]",
                "contentType": "endpoint"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), 'azure-ad-client-secret')]",
              "properties": {
                "value": "[parameters('clientSecret')]",
                "contentType": "client-secret"
              }
            }
          ],
          "outputs": {
            "secretsCreated": {
              "type": "array",
              "value": [
                "cosmos-postgresql-connection",
                "cosmos-mongodb-connection",
                "storage-connection-string",
                "azure-openai-api-key",
                "azure-openai-endpoint",
                "azure-ad-client-secret"
              ]
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'cosmos-mongo-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'cosmos-postgres-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'openai-deployment')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment')]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Resource Group Name"
      },
      "value": "[variables('resourceGroupName')]"
    },
    "frontendUrl": {
      "type": "string",
      "metadata": {
        "description": "Frontend Application URL"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'appservice-deployment'), '2022-09-01').outputs.frontendUrl.value]"
    },
    "backendUrl": {
      "type": "string",
      "metadata": {
        "description": "Backend API URL"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'appservice-deployment'), '2022-09-01').outputs.backendUrl.value]"
    },
    "openaiEndpoint": {
      "type": "string",
      "metadata": {
        "description": "Azure OpenAI Endpoint"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'openai-deployment'), '2022-09-01').outputs.endpoint.value]"
    },
    "storageAccountName": {
      "type": "string",
      "metadata": {
        "description": "Storage Account Name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'storage-deployment'), '2022-09-01').outputs.storageAccountName.value]"
    },
    "keyVaultName": {
      "type": "string",
      "metadata": {
        "description": "Key Vault Name"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'keyvault-deployment'), '2022-09-01').outputs.keyVaultName.value]"
    },
    "postgresConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Cosmos PostgreSQL Connection String"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'cosmos-postgres-deployment'), '2022-09-01').outputs.connectionString.value]"
    },
    "mongoConnectionString": {
      "type": "string",
      "metadata": {
        "description": "Cosmos MongoDB Connection String"
      },
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'cosmos-mongo-deployment'), '2022-09-01').outputs.connectionString.value]"
    },
    "nextSteps": {
      "type": "array",
      "metadata": {
        "description": "Next Steps"
      },
      "value": [
        "[format('1. Upload your application code to: {0}', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'appservice-deployment'), '2022-09-01').outputs.frontendUrl.value)]",
        "[format('2. Configure Azure AD app registration with redirect URI: {0}/auth/callback', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('resourceGroupName')), 'Microsoft.Resources/deployments', 'appservice-deployment'), '2022-09-01').outputs.frontendUrl.value)]",
        "3. Test the application endpoints",
        "4. Set up CI/CD pipeline for code deployments"
      ]
    }
  }
}